name: Fetch Blog Post Dates

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  fetch-posts:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium

      - name: Fetch blog post dates
        run: |
          node << 'EOF'
          const { chromium } = require('playwright');
          const fs = require('fs');

          const BLOGS = [
            { id: 'digitalocean', name: 'DigitalOcean Community', url: 'https://www.digitalocean.com/community/tags/ai' },
            { id: 'bair', name: 'BAIR Blog', url: 'https://bair.berkeley.edu/blog/' },
            { id: 'openai', name: 'OpenAI Blog', url: 'https://openai.com/blog' },
            { id: 'kdnuggets', name: 'KDnuggets', url: 'https://www.kdnuggets.com/' },
            { id: 'tds', name: 'Towards Data Science', url: 'https://towardsdatascience.com/' },
            { id: 'marktechpost', name: 'MarkTechPost', url: 'https://www.marktechpost.com/' },
            { id: 'huggingface', name: 'Hugging Face Blog', url: 'https://huggingface.co/blog' },
            { id: 'towardsai', name: 'Towards AI', url: 'https://towardsai.net/' },
            { id: 'holisticai', name: 'Holistic AI', url: 'https://www.holisticai.com/blog' },
            { id: 'analyticsvidhya', name: 'Analytics Vidhya', url: 'https://www.analyticsvidhya.com/blog/' },
            { id: 'mlmastery', name: 'Machine Learning Mastery', url: 'https://machinelearningmastery.com/blog/' },
            { id: 'anthropic', name: 'Anthropic Blog', url: 'https://www.anthropic.com/news' },
          ];

          async function getLastPostDate(browser, blog) {
            try {
              const page = await browser.newPage();
              await page.goto(blog.url, { waitUntil: 'domcontentloaded', timeout: 30000 });
              await page.waitForTimeout(3000);
              
              // Try to find date elements
              const dateText = await page.evaluate(() => {
                const dateSelectors = [
                  'time', '[datetime]', '.date', '.post-date', '.published', 
                  '[class*="date"]', '[class*="time"]', 'article time'
                ];
                
                for (const selector of dateSelectors) {
                  const el = document.querySelector(selector);
                  if (el) {
                    const datetime = el.getAttribute('datetime');
                    if (datetime) return datetime;
                    const text = el.textContent?.trim();
                    if (text && text.length < 50) return text;
                  }
                }
                return null;
              });
              
              await page.close();
              return dateText;
            } catch (error) {
              console.error(`Error fetching ${blog.name}:`, error.message);
              return null;
            }
          }

          async function main() {
            const browser = await chromium.launch();
            const results = { lastUpdated: new Date().toISOString(), blogs: {} };
            
            for (const blog of BLOGS) {
              console.log(`Fetching ${blog.name}...`);
              const date = await getLastPostDate(browser, blog);
              results.blogs[blog.id] = { 
                name: blog.name,
                lastPost: date,
                checkedAt: new Date().toISOString()
              };
            }
            
            await browser.close();
            fs.writeFileSync('public/posts.json', JSON.stringify(results, null, 2));
            console.log('Done! Results saved to public/posts.json');
          }

          main().catch(console.error);
          EOF

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add public/posts.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update blog post dates" && git push)

